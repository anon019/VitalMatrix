<!-- pages/nutrition-detail/nutrition-detail.wxml -->
<!-- è®¾è®¡æ¦‚å¿µï¼šè‡ªç„¶é¤æ¡Œ Natural Table - è¯¦æƒ…é¡µ -->
<view class="page-container">
  <!-- è£…é¥°èƒŒæ™¯ -->
  <view class="bg-decoration">
    <view class="bg-circle circle-1"></view>
    <view class="bg-circle circle-2"></view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-bowl">
      <view class="bowl-body"></view>
      <view class="steam steam-1"></view>
      <view class="steam steam-2"></view>
      <view class="steam steam-3"></view>
    </view>
    <text class="loading-text">æ­£åœ¨åŠ è½½...</text>
  </view>

  <view wx:else class="content">
    <!-- é¤é£Ÿç…§ç‰‡åŒºåŸŸ - æ²‰æµ¸å¼è®¾è®¡ -->
    <view class="photo-hero">
      <image
        class="hero-image"
        src="{{meal.photo_path}}"
        mode="aspectFill"
        binderror="onImageError"
        bindload="onImageLoad"
      />
      <view wx:if="{{!meal.photo_path}}" class="no-image">
        <text class="no-image-icon">ğŸ“·</text>
        <text class="no-image-text">æš‚æ— å›¾ç‰‡</text>
      </view>
      <!-- æ¸å˜é®ç½©å’Œä¿¡æ¯ -->
      <view class="hero-overlay">
        <view class="hero-info">
          <view class="meal-type-pill">{{mealTypeLabel}}</view>
          <text class="meal-datetime">{{mealTimeFormatted}}</text>
        </view>
      </view>
    </view>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <view class="main-content">
      <!-- è¥å…»æ¦‚è§ˆå¡ç‰‡ -->
      <view class="card nutrition-card anim-slide-up" style="animation-delay: 0ms;">
        <view class="card-header green-theme">
          <text class="card-icon">ğŸ¥—</text>
          <text class="card-title">è¥å…»æˆåˆ†</text>
        </view>
        <view class="card-body">
          <view class="nutrition-showcase">
            <!-- çƒ­é‡ä¸­å¿ƒ -->
            <view class="calorie-display">
              <text class="calorie-number">{{meal.total_calories}}</text>
              <text class="calorie-unit">åƒå¡</text>
            </view>
            <!-- å®é‡å…ƒç´  -->
            <view class="macro-row">
              <view class="macro-chip protein">
                <text class="chip-label">è›‹ç™½è´¨</text>
                <text class="chip-value">{{meal.total_protein}}g</text>
              </view>
              <view class="macro-chip carbs">
                <text class="chip-label">ç¢³æ°´</text>
                <text class="chip-value">{{meal.total_carbs}}g</text>
              </view>
              <view class="macro-chip fat">
                <text class="chip-label">è„‚è‚ª</text>
                <text class="chip-value">{{meal.total_fat}}g</text>
              </view>
            </view>
          </view>
          <view wx:if="{{meal.total_fiber > 0}}" class="fiber-note">
            <text class="fiber-icon">ğŸŒ¾</text>
            <text class="fiber-text">è†³é£Ÿçº¤ç»´ {{meal.total_fiber}}g</text>
          </view>
        </view>
      </view>

      <!-- AI åˆ†æåŒºåŸŸ -->
      <view wx:if="{{analysis}}" class="analysis-area">
        <!-- ç»¼åˆè¯„ä»·å¡ç‰‡ -->
        <view wx:if="{{analysis.nutrition_analysis}}" class="card rating-card anim-slide-up" style="animation-delay: 60ms;">
          <view class="card-header amber-theme">
            <text class="card-icon">â­</text>
            <text class="card-title">ç»¼åˆè¯„ä»·</text>
            <view class="rating-pill" style="background: {{ratingBadgeColor}}">
              {{analysis.nutrition_analysis.overall_rating}}
            </view>
          </view>
          <view class="card-body rating-body">
            <view class="score-display">
              <text class="score-number" style="color: {{ratingScoreColor}}">{{analysis.nutrition_analysis.overall_score}}</text>
              <text class="score-suffix">åˆ†</text>
            </view>
            <text wx:if="{{aiModel}}" class="ai-model-tag">{{aiModel}}</text>
          </view>
        </view>

        <!-- è¯†åˆ«çš„é£Ÿç‰©å¡ç‰‡ -->
        <view wx:if="{{analysis.identified_foods && analysis.identified_foods.length > 0}}" class="card foods-card anim-slide-up" style="animation-delay: 120ms;">
          <view class="card-header blue-theme">
            <text class="card-icon">ğŸ±</text>
            <text class="card-title">è¯†åˆ«çš„é£Ÿç‰©</text>
            <text class="card-count">{{analysis.identified_foods.length}}é¡¹</text>
          </view>
          <view class="card-body">
            <view class="foods-list">
              <view wx:for="{{analysis.identified_foods}}" wx:key="index" class="food-item">
                <view class="food-main">
                  <text class="food-name">{{item.name}}</text>
                  <view class="food-weight-tag">çº¦ {{item.weight_g}}g</view>
                </view>
                <view class="food-stats">
                  <view class="food-calories">
                    <text class="cal-value">{{item.calories}}</text>
                    <text class="cal-unit">kcal</text>
                  </view>
                  <view class="food-macros">
                    <text class="macro-item">P {{item.protein}}g</text>
                    <text class="macro-sep">Â·</text>
                    <text class="macro-item">C {{item.carbs}}g</text>
                    <text class="macro-sep">Â·</text>
                    <text class="macro-item">F {{item.fat}}g</text>
                  </view>
                </view>
                <view wx:if="{{item.notes}}" class="food-notes">
                  <text class="notes-icon">ğŸ’¡</text>
                  <text class="notes-text">{{item.notes}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- è¥å…»åˆ†æå¡ç‰‡ -->
        <view wx:if="{{analysis.nutrition_analysis}}" class="card analysis-card anim-slide-up" style="animation-delay: 180ms;">
          <view class="card-header purple-theme">
            <text class="card-icon">ğŸ“Š</text>
            <text class="card-title">è¥å…»åˆ†æ</text>
          </view>
          <view class="card-body">
            <view class="analysis-list">
              <!-- ç¢³æ°´åˆ†æ -->
              <view class="analysis-item">
                <view class="analysis-top">
                  <view class="analysis-label">
                    <text class="label-emoji">ğŸš</text>
                    <text class="label-text">ç¢³æ°´åŒ–åˆç‰©</text>
                  </view>
                  <text class="analysis-rating {{carbsRatingClass}}">
                    {{analysis.nutrition_analysis.carbs_analysis.rating}}
                  </text>
                </view>
                <text class="analysis-comment">{{analysis.nutrition_analysis.carbs_analysis.comment}}</text>
              </view>
              <!-- è›‹ç™½è´¨åˆ†æ -->
              <view class="analysis-item">
                <view class="analysis-top">
                  <view class="analysis-label">
                    <text class="label-emoji">ğŸ¥©</text>
                    <text class="label-text">è›‹ç™½è´¨</text>
                  </view>
                  <text class="analysis-rating {{proteinRatingClass}}">
                    {{analysis.nutrition_analysis.protein_analysis.rating}}
                  </text>
                </view>
                <text class="analysis-comment">{{analysis.nutrition_analysis.protein_analysis.comment}}</text>
              </view>
              <!-- è„‚è‚ªåˆ†æ -->
              <view class="analysis-item">
                <view class="analysis-top">
                  <view class="analysis-label">
                    <text class="label-emoji">ğŸ¥‘</text>
                    <text class="label-text">è„‚è‚ª</text>
                  </view>
                  <text class="analysis-rating {{fatRatingClass}}">
                    {{analysis.nutrition_analysis.fat_analysis.rating}}
                  </text>
                </view>
                <text class="analysis-comment">{{analysis.nutrition_analysis.fat_analysis.comment}}</text>
              </view>
            </view>
            <!-- é’ è­¦å‘Š -->
            <view wx:if="{{analysis.nutrition_analysis.sodium_warning && analysis.nutrition_analysis.sodium_comment}}" class="sodium-alert">
              <text class="alert-icon">âš ï¸</text>
              <text class="alert-text">{{analysis.nutrition_analysis.sodium_comment}}</text>
            </view>
          </view>
        </view>

        <!-- å¥åº·æ´å¯Ÿå¡ç‰‡ -->
        <view wx:if="{{analysis.health_insights}}" class="card insights-card anim-slide-up" style="animation-delay: 240ms;">
          <view class="card-header teal-theme">
            <text class="card-icon">ğŸ’¡</text>
            <text class="card-title">å¥åº·æ´å¯Ÿ</text>
          </view>
          <view class="card-body">
            <!-- ä¼˜ç‚¹ -->
            <view wx:if="{{analysis.health_insights.strengths && analysis.health_insights.strengths.length > 0}}" class="insight-group">
              <view class="group-header good">
                <text class="group-icon">âœ…</text>
                <text class="group-title">ä¼˜ç‚¹</text>
              </view>
              <view class="insight-list">
                <view wx:for="{{analysis.health_insights.strengths}}" wx:key="index" class="insight-item good">
                  <text class="insight-bullet">â€¢</text>
                  <text class="insight-text">{{item}}</text>
                </view>
              </view>
            </view>
            <!-- éœ€æ”¹è¿› -->
            <view wx:if="{{analysis.health_insights.weaknesses && analysis.health_insights.weaknesses.length > 0}}" class="insight-group">
              <view class="group-header warn">
                <text class="group-icon">ğŸ’¡</text>
                <text class="group-title">éœ€æ”¹è¿›</text>
              </view>
              <view class="insight-list">
                <view wx:for="{{analysis.health_insights.weaknesses}}" wx:key="index" class="insight-item warn">
                  <text class="insight-bullet">â€¢</text>
                  <text class="insight-text">{{item}}</text>
                </view>
              </view>
            </view>
            <!-- é£é™©æç¤º -->
            <view wx:if="{{analysis.health_insights.risk_factors && analysis.health_insights.risk_factors.length > 0}}" class="insight-group">
              <view class="group-header risk">
                <text class="group-icon">ğŸš¨</text>
                <text class="group-title">é£é™©æç¤º</text>
              </view>
              <view class="insight-list">
                <view wx:for="{{analysis.health_insights.risk_factors}}" wx:key="index" class="insight-item risk">
                  <text class="insight-bullet">â€¢</text>
                  <text class="insight-text">{{item}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- é¥®é£Ÿå»ºè®®å¡ç‰‡ -->
        <view wx:if="{{analysis.recommendations}}" class="card recommend-card anim-slide-up" style="animation-delay: 300ms;">
          <view class="card-header green-theme">
            <text class="card-icon">ğŸ“</text>
            <text class="card-title">é¥®é£Ÿå»ºè®®</text>
          </view>
          <view class="card-body">
            <!-- æ€»ç»“ -->
            <view wx:if="{{analysis.recommendations.summary}}" class="summary-box">
              <text class="summary-text">{{analysis.recommendations.summary}}</text>
            </view>

            <!-- è¡ŒåŠ¨æ¸…å• -->
            <view wx:if="{{analysis.recommendations.action_items && analysis.recommendations.action_items.length > 0}}" class="action-section">
              <view class="section-label">
                <text class="label-icon">ğŸ“‹</text>
                <text class="label-text">è¡ŒåŠ¨æ¸…å•</text>
              </view>
              <view class="action-list">
                <view wx:for="{{analysis.recommendations.action_items}}" wx:key="index" class="action-item priority-{{item.priority}}">
                  <view class="action-header">
                    <text class="action-number">{{index + 1}}</text>
                    <text class="action-text">{{item.action}}</text>
                  </view>
                  <text class="action-rationale">{{item.rationale}}</text>
                </view>
              </view>
            </view>

            <!-- è¡¥æ°´æé†’ -->
            <view wx:if="{{analysis.recommendations.hydration_reminder}}" class="hydration-box">
              <text class="hydration-icon">ğŸ’§</text>
              <text class="hydration-text">{{analysis.recommendations.hydration_reminder}}</text>
            </view>

            <!-- ä¸‹ä¸€é¤æ¨èï¼ˆæ–°ç‰ˆæœ¬ï¼šæ•°ç»„æ ¼å¼ï¼‰ -->
            <view wx:if="{{analysis.recommendations.next_meals && analysis.recommendations.next_meals.length > 0}}" class="next-meals-section">
              <view class="section-label">
                <text class="label-icon">ğŸ½ï¸</text>
                <text class="label-text">ä¸‹ä¸€é¤æ¨è</text>
              </view>
              <view wx:for="{{analysis.recommendations.next_meals}}" wx:key="index" class="next-meal-card">
                <view class="meal-card-header">
                  <text class="meal-title">{{item.meal}}</text>
                  <view class="meal-calories-tag">{{item.total_calories}} kcal</view>
                </view>
                <view class="dishes-list">
                  <view wx:for="{{item.dishes}}" wx:for-item="dish" wx:for-index="dishIndex" wx:key="dishIndex" class="dish-card">
                    <view class="dish-top">
                      <text class="dish-name">{{dish.name}}</text>
                      <text class="dish-cal">{{dish.calories}} kcal</text>
                    </view>
                    <view class="dish-detail">
                      <view class="detail-row">
                        <text class="detail-label">é£Ÿæ</text>
                        <text class="detail-value">{{dish.ingredients}}</text>
                      </view>
                      <view class="detail-row">
                        <text class="detail-label">åšæ³•</text>
                        <text class="detail-value">{{dish.method}}</text>
                      </view>
                    </view>
                    <view class="dish-benefit">
                      <text class="benefit-icon">ğŸ’š</text>
                      <text class="benefit-text">{{dish.benefit}}</text>
                    </view>
                  </view>
                </view>
                <view wx:if="{{item.reason}}" class="meal-reason">
                  <text class="reason-text">{{item.reason}}</text>
                </view>
              </view>
            </view>

            <!-- ä¸‹ä¸€é¤å»ºè®®ï¼ˆæ—§ç‰ˆæœ¬å…¼å®¹ï¼šå­—ç¬¦ä¸²æ ¼å¼ï¼‰ -->
            <view wx:if="{{!analysis.recommendations.next_meals && analysis.recommendations.next_meal_menu}}" class="next-meal-menu">
              <view class="section-label">
                <text class="label-icon">ğŸ½ï¸</text>
                <text class="label-text">ä¸‹ä¸€é¤æ¨è</text>
              </view>
              <view class="menu-content">
                <text class="menu-text">{{formattedNextMealMenu}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç”¨æˆ·å¤‡æ³¨ -->
      <view wx:if="{{meal.notes}}" class="card notes-card anim-slide-up" style="animation-delay: 360ms;">
        <view class="card-header gray-theme">
          <text class="card-icon">ğŸ“Œ</text>
          <text class="card-title">å¤‡æ³¨</text>
        </view>
        <view class="card-body">
          <text class="notes-content">{{meal.notes}}</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons anim-slide-up" style="animation-delay: 420ms;">
        <button class="btn-primary" bindtap="generatePoster">
          <text class="btn-icon">ğŸ¨</text>
          <text class="btn-text">ç”Ÿæˆåˆ†äº«æµ·æŠ¥</text>
        </button>
        <button class="btn-danger" bindtap="deleteMeal">
          <text class="btn-icon">ğŸ—‘ï¸</text>
          <text class="btn-text">åˆ é™¤</text>
        </button>
      </view>
    </view>
  </view>

  <!-- æµ·æŠ¥ç”Ÿæˆä¸­é®ç½© -->
  <view wx:if="{{generatingPoster}}" class="modal-overlay">
    <view class="modal-box">
      <view class="modal-spinner">
        <view class="spinner-ring"></view>
        <text class="spinner-icon">ğŸ¨</text>
      </view>
      <text class="modal-title">æ­£åœ¨ç”Ÿæˆæµ·æŠ¥</text>
      <text class="modal-subtitle">è¯·ç¨å€™...</text>
    </view>
  </view>

  <!-- æµ·æŠ¥é¢„è§ˆå¼¹çª— -->
  <view wx:if="{{showPosterPreview}}" class="poster-overlay" bindtap="closePosterPreview">
    <view class="poster-container" catchtap="onPreviewTap">
      <image class="poster-image" src="{{posterPath}}" mode="widthFix" />
      <view class="poster-buttons">
        <button class="poster-btn save" bindtap="savePoster">
          <text class="btn-icon">ğŸ’¾</text>
          <text>ä¿å­˜åˆ°ç›¸å†Œ</text>
        </button>
        <button class="poster-btn close" bindtap="closePosterPreview">
          <text>å…³é—­</text>
        </button>
      </view>
    </view>
  </view>

  <!-- éšè—çš„Canvasç”¨äºç”Ÿæˆæµ·æŠ¥ -->
  <canvas type="2d" id="posterCanvas" class="poster-canvas"></canvas>
</view>
