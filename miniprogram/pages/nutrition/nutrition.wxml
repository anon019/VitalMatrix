<!-- pages/nutrition/nutrition.wxml -->
<!-- è®¾è®¡æ¦‚å¿µï¼šè‡ªç„¶é¤æ¡Œ Natural Table -->
<view class="page-container">
  <!-- è£…é¥°èƒŒæ™¯å…ƒç´  -->
  <view class="bg-decoration">
    <view class="bg-circle circle-1"></view>
    <view class="bg-circle circle-2"></view>
    <view class="bg-circle circle-3"></view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-bowl">
      <view class="bowl-body"></view>
      <view class="steam steam-1"></view>
      <view class="steam steam-2"></view>
      <view class="steam steam-3"></view>
    </view>
    <text class="loading-text">æ­£åœ¨å‡†å¤‡...</text>
  </view>

  <view wx:else class="content">
    <!-- é¡µé¢æ ‡é¢˜åŒº -->
    <view class="page-header">
      <view class="header-main">
        <text class="page-title">é¥®é£Ÿè®°å½•</text>
        <text class="page-subtitle">è®°å½•æ¯ä¸€é¤ï¼Œå…³çˆ±æ¯ä¸€å¤©</text>
      </view>
      <view class="header-date">
        <text class="date-day">{{currentDay}}</text>
        <text class="date-week">{{currentWeekday}}</text>
      </view>
    </view>

    <!-- å¿«æ·ä¸Šä¼ åŒºåŸŸ -->
    <view class="upload-card">
      <view class="upload-header">
        <text class="upload-title">è®°å½•è¿™ä¸€é¤</text>
      </view>

      <!-- é¤æ¬¡é€‰æ‹© - èƒ¶å›Šå¼è®¾è®¡ -->
      <view class="meal-selector">
        <view class="meal-pill {{selectedMealType === 'breakfast' ? 'active' : ''}}"
              data-type="breakfast" bindtap="selectMealType">
          <text class="pill-icon">ğŸŒ…</text>
          <text class="pill-text">æ—©é¤</text>
        </view>
        <view class="meal-pill {{selectedMealType === 'lunch' ? 'active' : ''}}"
              data-type="lunch" bindtap="selectMealType">
          <text class="pill-icon">â˜€ï¸</text>
          <text class="pill-text">åˆé¤</text>
        </view>
        <view class="meal-pill {{selectedMealType === 'dinner' ? 'active' : ''}}"
              data-type="dinner" bindtap="selectMealType">
          <text class="pill-icon">ğŸŒ™</text>
          <text class="pill-text">æ™šé¤</text>
        </view>
        <view class="meal-pill {{selectedMealType === 'snack' ? 'active' : ''}}"
              data-type="snack" bindtap="selectMealType">
          <text class="pill-icon">ğŸ</text>
          <text class="pill-text">åŠ é¤</text>
        </view>
      </view>

      <!-- æ‹ç…§æŒ‰é’® -->
      <button class="capture-btn" bindtap="takePhoto">
        <view class="btn-icon-wrap">
          <text class="btn-icon">ğŸ“·</text>
        </view>
        <text class="btn-text">æ‹ç…§è®°å½•</text>
        <view class="btn-arrow">â†’</view>
      </button>
    </view>

    <!-- ä»Šæ—¥è¥å…»æ¦‚è§ˆ -->
    <view wx:if="{{todaySummary}}" class="summary-section">
      <view class="section-header">
        <text class="section-title">ä»Šæ—¥è¥å…»</text>
        <view class="section-badge">
          <text class="badge-text">{{todaySummary.meals_count || 0}}é¤</text>
        </view>
      </view>

      <!-- è¥å…»ç¯å½¢å›¾å¡ç‰‡ -->
      <view class="nutrition-overview">
        <!-- çƒ­é‡ä¸­å¿ƒ -->
        <view class="calorie-center">
          <view class="calorie-ring">
            <view class="ring-progress" style="--progress: {{calorieProgress}}deg;"></view>
            <view class="ring-inner">
              <text class="calorie-value">{{todaySummary.total_calories}}</text>
              <text class="calorie-unit">åƒå¡</text>
            </view>
          </view>
          <text class="calorie-label">æ€»çƒ­é‡</text>
        </view>

        <!-- ä¸‰å¤§å®é‡å…ƒç´  -->
        <view class="macro-grid">
          <view class="macro-item protein">
            <view class="macro-bar">
              <view class="bar-fill" style="height: {{proteinProgress}}%;"></view>
            </view>
            <view class="macro-info">
              <text class="macro-value">{{todaySummary.total_protein}}</text>
              <text class="macro-unit">g</text>
            </view>
            <text class="macro-label">è›‹ç™½è´¨</text>
          </view>
          <view class="macro-item carbs">
            <view class="macro-bar">
              <view class="bar-fill" style="height: {{carbsProgress}}%;"></view>
            </view>
            <view class="macro-info">
              <text class="macro-value">{{todaySummary.total_carbs}}</text>
              <text class="macro-unit">g</text>
            </view>
            <text class="macro-label">ç¢³æ°´</text>
          </view>
          <view class="macro-item fat">
            <view class="macro-bar">
              <view class="bar-fill" style="height: {{fatProgress}}%;"></view>
            </view>
            <view class="macro-info">
              <text class="macro-value">{{todaySummary.total_fat}}</text>
              <text class="macro-unit">g</text>
            </view>
            <text class="macro-label">è„‚è‚ª</text>
          </view>
        </view>
      </view>
    </view>

    <!-- é¤é£Ÿè®°å½•åˆ—è¡¨ -->
    <view class="meals-section">
      <view class="section-header">
        <text class="section-title">æœ€è¿‘è®°å½•</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{meals.length === 0}}" class="empty-state">
        <view class="empty-illustration">
          <text class="empty-plate">ğŸ½ï¸</text>
          <view class="empty-sparkle sparkle-1">âœ¨</view>
          <view class="empty-sparkle sparkle-2">âœ¨</view>
        </view>
        <text class="empty-title">è¿˜æ²¡æœ‰é¥®é£Ÿè®°å½•</text>
        <text class="empty-hint">æ‹å¼ ç…§ç‰‡å¼€å§‹è®°å½•ä»Šå¤©çš„ç¾é£Ÿå§</text>
      </view>

      <!-- é¤é£Ÿåˆ—è¡¨ -->
      <view wx:else class="meals-list">
        <view wx:for="{{meals}}" wx:key="id"
              class="meal-card anim-slide-up"
              style="animation-delay: {{index * 60}}ms;"
              data-meal-id="{{item.id}}" bindtap="viewMealDetail">

          <!-- é¤é£Ÿå›¾ç‰‡ -->
          <view class="meal-image-wrap">
            <image class="meal-image" src="{{item.thumbnail_path}}" mode="aspectFill" />
            <view class="meal-type-tag">{{item.meal_type_label}}</view>
          </view>

          <!-- é¤é£Ÿä¿¡æ¯ -->
          <view class="meal-content">
            <view class="meal-top-row">
              <text class="meal-time">{{item.meal_time_formatted}}</text>
              <text wx:if="{{item.model_name}}" class="ai-badge">{{item.model_name}}</text>
            </view>

            <!-- è¥å…»æ•°æ® -->
            <view class="meal-nutrition-row">
              <view class="nutrition-pill calories-pill">
                <text class="pill-value">{{item.total_calories}}</text>
                <text class="pill-unit">kcal</text>
              </view>
              <view class="nutrition-mini">
                <text class="mini-item">P {{item.total_protein}}g</text>
                <text class="mini-sep">Â·</text>
                <text class="mini-item">C {{item.total_carbs}}g</text>
                <text class="mini-sep">Â·</text>
                <text class="mini-item">F {{item.total_fat}}g</text>
              </view>
            </view>

            <!-- è¯„åˆ† -->
            <view wx:if="{{item.gemini_analysis && item.gemini_analysis.nutrition_analysis}}" class="meal-rating-row">
              <view class="rating-chip {{item.ratingColorClass}}">
                <text class="chip-label">{{item.gemini_analysis.nutrition_analysis.overall_rating}}</text>
                <text class="chip-score">{{item.gemini_analysis.nutrition_analysis.overall_score}}åˆ†</text>
              </view>
            </view>
          </view>

          <!-- ç®­å¤´ -->
          <view class="meal-arrow">
            <text class="arrow-icon">â€º</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†æä¸­å¼¹çª— -->
  <view wx:if="{{analyzing}}" class="analyzing-overlay">
    <view class="analyzing-modal">
      <view class="analyzing-animation">
        <view class="scan-ring"></view>
        <text class="scan-icon">ğŸ”</text>
      </view>
      <text class="analyzing-title">AI åˆ†æä¸­</text>
      <text class="analyzing-subtitle">æ­£åœ¨è¯†åˆ«é£Ÿç‰©å’Œè¥å…»æˆåˆ†...</text>
      <view class="progress-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
    </view>
  </view>
</view>
